<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>파스텔톤 주간 플래너</title>

  <!-- ✅ 파비콘(사이트 아이콘) - 아래 설명 참고 -->
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="favicon-32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="favicon-16.png" sizes="16x16">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">

  <style>
    :root{
      --bg:#fff4f8;
      --border:#f2c7d6;
      --header:#ffe0eb;
      --timebg:#ffedf4;
      --text:#111;
      --focus: color-mix(in srgb, var(--border) 70%, #000 30%);
      --card: color-mix(in srgb, var(--bg) 75%, #fff 25%);

      /* 화면용(사용자 조절 가능) */
      --timeW: 110px;
      --dayW: 140px;  /* 사용자 조절을 위해 px 기본 */
      --rowH: 36px;

      /* 인쇄 방향 */
      --paper: portrait; /* portrait | landscape */
      --printMargin: 8mm;

      /* 인쇄 스케일(자동 계산) */
      --printScale: 1;

      /* 달력 */
      --calAccent: color-mix(in srgb, var(--border) 80%, #fff 20%);
      --sat: #1565c0;
      --sun: #c62828;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: "Malgun Gothic", Arial, sans-serif;
      color:var(--text);
      background: var(--bg);
    }

    /* ===== 상단바 ===== */
    .appbar{
      position: sticky;
      top: 0;
      z-index: 60;
      backdrop-filter: blur(10px);
      background: color-mix(in srgb, var(--bg) 78%, white 22%);
      border-bottom: 1px solid var(--border);
    }
    .appbar-inner{
      max-width: 1180px;
      margin: 0 auto;
      padding: 10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
    }
    .left{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      min-width: 240px;
    }
    .brand{
      font-weight: 1000;
      font-size: 16px;
      letter-spacing: -0.2px;
      white-space: nowrap;
    }
    .hint{
      font-size: 12px;
      opacity: 0.7;
      white-space: nowrap;
    }
    .right{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap: wrap;
    }

    .btn, .select, .input{
      border: 1px solid var(--border);
      background: white;
      padding: 7px 10px;
      border-radius: 10px;
      font-weight: 900;
      font-size: 13px;
      opacity: .97;
    }
    .btn{ cursor:pointer; user-select:none; }
    .btn:hover{ opacity: 1; }
    .btn.ghost{
      background: transparent;
      border: 1px dashed var(--border);
    }
    .btn.danger{
      border-color: #ff6b6b;
      color: #b00020;
      background: #fff5f5;
    }
    .btn.danger:hover{
      background: #ffecec;
    }

    /* 스위치 */
    .switch{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, white 70%, var(--bg) 30%);
      font-weight: 900;
      font-size: 13px;
      user-select:none;
      cursor:pointer;
    }
    .switch input{ display:none; }
    .track{
      width: 38px; height: 22px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      position: relative;
      flex: 0 0 auto;
    }
    .knob{
      width: 18px; height: 18px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--border) 55%, #fff 45%);
      position:absolute;
      top: 1px; left: 1px;
      transition: left .18s ease, background .18s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,.12);
    }
    .switch.on .track{
      background: color-mix(in srgb, var(--header) 65%, #fff 35%);
    }
    .switch.on .knob{
      left: 19px;
      background: color-mix(in srgb, var(--border) 85%, #fff 15%);
    }

    /* ===== 본문 ===== */
    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px 12px 30px;
    }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }

    /* 제목: 항상 표시 */
    .title-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .title-stack{
      display:flex;
      flex-direction: column;
      gap:4px;
    }
    .planner-title{
      font-weight: 1000;
      font-size: 18px;
      letter-spacing: -0.2px;
    }
    .meta{
      font-size: 12px;
      opacity: .75;
      font-weight: 900;
      min-height: 14px;
    }
    .title-edit{
      display:none;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .title-edit.show{ display:flex; }

    /* 테이블 */
    .table-wrap{
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
      background: #fff;
      position: relative;
    }

    table.planner{
      width: 100%;
      min-width: 860px;
      border-collapse: collapse;
      background: #fff;
      table-layout: fixed;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    col.timecol{ width: var(--timeW); }
    col.daycol{ width: var(--dayW); }

    .planner th, .planner td{
      border: 1px solid var(--border);
      text-align: center;
      vertical-align: middle;
      height: var(--rowH);
      padding: 6px 6px;
      font-size: 14px;
    }

    .planner thead th{
      background: var(--header);
      font-weight: 900;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .planner td.time{
      background: var(--timebg);
      font-weight: 900;
      position: sticky;
      left: 0;
      z-index: 4;
    }

    /* 좌상단 대각선: 얇은 선 */
    .planner th.corner{
      position: sticky;
      top: 0;
      left: 0;
      z-index: 6;
      padding: 0;
      background: var(--header);
    }
    .cornerBox{
      position: relative;
      width: 100%;
      height: 100%;
      min-height: 44px;
    }
    .cornerBox::after{
      content:"";
      position:absolute;
      inset:0;
      background: linear-gradient(135deg,
        transparent 49.4%,
        color-mix(in srgb, var(--border) 88%, #fff 12%) 50%,
        transparent 50.6%);
      pointer-events:none;
    }
    .cornerTime{
      position:absolute;
      left: 10px;
      bottom: 6px;
      font-weight: 1000;
      font-size: 13px;
    }
    .cornerDay{
      position:absolute;
      right: 10px;
      top: 6px;
      font-weight: 1000;
      font-size: 13px;
    }

    /* 요일 헤더 + 날짜 */
    .dow{
      display:flex;
      flex-direction: column;
      gap: 2px;
      line-height: 1.05;
      align-items:center;
      justify-content:center;
    }
    .dow .name{ font-weight: 1000; }
    .dow .date{
      font-size: 11px;
      opacity: .7;
      font-weight: 900;
      min-height: 12px;
    }
    .sat .name, .sat .date{ color: var(--sat); opacity: .9; }
    .sun .name, .sun .date{ color: var(--sun); opacity: .9; }

    /* 셀 */
    .planner td.cell{
      cursor: pointer;
      text-align: left;
      padding: 6px 8px;
      white-space: pre-wrap;
      word-break: break-word;
      background: #fff;
    }
    .planner td.cell:hover{
      background: color-mix(in srgb, var(--header) 18%, white 82%);
    }
    .planner td.cell.empty::before{
      content: "클릭해서 입력";
      opacity: .25;
    }
    .planner td.cell .preview{
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* 리사이즈 핸들(동일 폭/동일 높이) */
    .resize-handle{
      position:absolute;
      z-index: 20;
      user-select:none;
      touch-action:none;
      background: transparent;
    }
    .resize-col{
      top: 6px;
      right: 8px;
      width: 22px;
      height: 22px;
      border-radius: 8px;
      border: 1px dashed var(--border);
      background: color-mix(in srgb, white 70%, var(--bg) 30%);
      cursor: col-resize;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 14px;
      font-weight: 1000;
      opacity: .95;
    }
    .resize-row{
      bottom: 8px;
      left: 8px;
      width: 22px;
      height: 22px;
      border-radius: 8px;
      border: 1px dashed var(--border);
      background: color-mix(in srgb, white 70%, var(--bg) 30%);
      cursor: row-resize;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 14px;
      font-weight: 1000;
      opacity: .95;
    }

    /* ===== 모달(메모/달력/공지) 공용 ===== */
    .backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 100;
      padding: 14px;
    }
    .modal{
      width: min(780px, 100%);
      background: #fff;
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      overflow: hidden;
    }
    .modal-header{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      background: color-mix(in srgb, var(--bg) 75%, #fff 25%);
      border-bottom: 1px solid var(--border);
    }
    .modal-title{
      font-weight: 1000;
      font-size: 14px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
    }
    .pill{
      display:inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 12px;
      font-weight: 1000;
      opacity: .92;
    }
    .modal-body{
      padding: 12px;
    }
    .modal-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      padding: 12px;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
    }

    textarea{
      width: 100%;
      min-height: 220px;
      resize: vertical;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px;
      font-size: 14px;
      line-height: 1.4;
      outline: none;
    }
    textarea:focus{
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--border) 50%, transparent 50%);
      border-color: var(--focus);
    }

    /* ===== 달력 UI ===== */
    .cal-head{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .cal-head .nav{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .cal-grid{
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow:hidden;
    }
    .cal-row, .cal-dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
    }
    .cal-dow div{
      background: color-mix(in srgb, var(--header) 75%, #fff 25%);
      border-bottom: 1px solid var(--border);
      padding: 8px 6px;
      text-align:center;
      font-weight: 1000;
      font-size: 13px;
    }
    .cal-dow .sat{ color: var(--sat); }
    .cal-dow .sun{ color: var(--sun); }

    .cal-week{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      border-bottom: 1px solid var(--border);
      cursor:pointer;
      background:#fff;
    }
    .cal-week:last-child{ border-bottom:none; }
    .cal-week:hover{
      background: color-mix(in srgb, var(--header) 18%, #fff 82%);
    }
    .cal-cell{
      padding: 10px 6px;
      text-align:center;
      border-right: 1px solid var(--border);
      font-weight: 900;
      min-height: 44px;
      display:flex;
      flex-direction: column;
      justify-content:center;
      gap:2px;
    }
    .cal-cell:last-child{ border-right:none; }
    .cal-cell .d{ font-size: 14px; }
    .cal-cell .m{
      font-size: 11px;
      opacity: .7;
      font-weight: 1000;
    }
    .cal-cell.out{ opacity: .35; }
    .cal-cell.sat{ color: var(--sat); }
    .cal-cell.sun{ color: var(--sun); }

    .week-badge{
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, #fff 70%, var(--bg) 30%);
      font-weight: 1000;
      font-size: 12px;
      opacity: .95;
    }

    /* ===== 인쇄: 자동 스케일 & PC 인쇄 모드 강제 ===== */
    @media print{
      body{
        background:#fff;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      @page{
        size: A4 var(--paper);
        margin: var(--printMargin);
      }
      .appbar{ display:none !important; }

      .wrap{
        max-width:none;
        padding:0;
      }
      .card{
        border:none;
        background:#fff;
        padding:0;
      }

      /* 인쇄에서 스크롤/둥근모서리 제거 */
      .table-wrap{
        overflow: visible !important;
        border-radius: 0 !important;
      }
      table.planner{
        min-width: 0 !important;
        width: 100% !important;
        border-radius: 0 !important;
        transform: scale(var(--printScale));
        transform-origin: top left;
      }

      /* sticky 해제 */
      .planner thead th,
      .planner td.time,
      .planner th.corner{
        position: static !important;
      }

      /* placeholder 숨김 */
      .planner td.cell.empty::before{ content:""; }

      /* 리사이즈 핸들 숨김 */
      .resize-handle{ display:none !important; }
    }

    /* 모바일 */
    @media (max-width: 520px){
      .hint{ display:none; }
      .input{ min-width: 160px; }
      .btn, .select{ font-size: 12px; }
      .switch{ font-size: 12px; }
    }
  </style>
</head>

<body>
  <header class="appbar">
    <div class="appbar-inner">
      <div class="left">
        <div class="brand">파스텔톤 주간 플래너</div>
        <div class="hint">칸 클릭 → 입력 · ↔/↕로 전체 칸 크기 조절</div>

        <button class="btn" id="noticeBtn" type="button">공지</button>

        <label class="switch" id="dateSwitch" title="날짜 연동(달력에서 주 선택)">
          <span class="track"><span class="knob"></span></span>
          <span>날짜 연동</span>
          <input type="checkbox" id="dateLinkToggle" />
        </label>

        <label class="switch" id="titleSwitch" title="제목 편집/기간 표시">
          <span class="track"><span class="knob"></span></span>
          <span>제목 편집</span>
          <input type="checkbox" id="titleEditToggle" />
        </label>

        <button class="btn" id="pickWeekBtn" type="button">주 선택</button>
      </div>

      <div class="right">
        <select class="select" id="orientationSelect" title="인쇄 방향">
          <option value="portrait">세로(A4)</option>
          <option value="landscape">가로(A4)</option>
        </select>

        <button class="btn" id="printBtn" type="button">인쇄</button>

        <button class="btn" id="exportBtn" type="button">내보내기</button>
        <button class="btn" id="importBtn" type="button">가져오기</button>

        <button class="btn ghost" id="resetSizeBtn" type="button">크기 초기화</button>
        <button class="btn danger" id="resetAllBtn" type="button">전체 초기화</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">

      <div class="title-row">
        <div class="title-stack">
          <div class="planner-title" id="plannerTitleText">주간 플래너</div>
          <div class="meta" id="plannerMetaText"></div>
        </div>

        <div class="title-edit" id="titleEdit">
          <input class="input" id="titleInput" placeholder="제목 변경 가능" />
        </div>
      </div>

      <div class="table-wrap" id="tableWrap">
        <div class="resize-handle resize-col" id="colResize" title="요일 열 너비 조절(전체 동일)">↔</div>
        <div class="resize-handle resize-row" id="rowResize" title="시간 칸 높이 조절(전체 동일)">↕</div>

        <table class="planner" id="plannerTable" aria-label="주간 플래너">
          <colgroup>
            <col class="timecol" />
            <col class="daycol" span="7" />
          </colgroup>

          <thead>
            <tr>
              <th class="corner">
                <div class="cornerBox">
                  <div class="cornerDay">요일</div>
                  <div class="cornerTime">시간</div>
                </div>
              </th>

              <th><div class="dow"><div class="name">월</div><div class="date" data-dow="0"></div></div></th>
              <th><div class="dow"><div class="name">화</div><div class="date" data-dow="1"></div></div></th>
              <th><div class="dow"><div class="name">수</div><div class="date" data-dow="2"></div></div></th>
              <th><div class="dow"><div class="name">목</div><div class="date" data-dow="3"></div></div></th>
              <th><div class="dow"><div class="name">금</div><div class="date" data-dow="4"></div></div></th>
              <th class="sat"><div class="dow"><div class="name">토</div><div class="date" data-dow="5"></div></div></th>
              <th class="sun"><div class="dow"><div class="name">일</div><div class="date" data-dow="6"></div></div></th>
            </tr>
          </thead>

          <tbody id="rows"></tbody>
        </table>
      </div>

    </div>
  </main>

  <!-- 메모 모달 -->
  <div class="backdrop" id="memoBackdrop" aria-modal="true" role="dialog">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">
          <span class="pill" id="pillTime">--:--</span>
          <span class="pill" id="pillDay">요일</span>
        </div>
        <button class="btn" id="closeMemo" type="button">닫기</button>
      </div>
      <div class="modal-body">
        <textarea id="memoText" placeholder="여기에 내용을 입력해줘."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" id="clearCellBtn" type="button">이 칸 비우기</button>
        <button class="btn" id="saveMemo" type="button">저장</button>
      </div>
    </div>
  </div>

  <!-- 달력 모달 -->
  <div class="backdrop" id="calBackdrop" aria-modal="true" role="dialog">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">
          <span class="pill">주 선택</span>
          <span class="pill" id="calLabel"></span>
        </div>
        <button class="btn" id="closeCal" type="button">닫기</button>
      </div>

      <div class="modal-body">
        <div class="cal-head">
          <div class="nav">
            <button class="btn" id="calPrev" type="button">◀</button>
            <button class="btn" id="calToday" type="button">이번 달</button>
            <button class="btn" id="calNext" type="button">▶</button>
          </div>
          <span class="week-badge" id="mwBadge"></span>
        </div>

        <div class="cal-grid" id="calGrid">
          <div class="cal-dow">
            <div>월</div><div>화</div><div>수</div><div>목</div><div>금</div>
            <div class="sat">토</div><div class="sun">일</div>
          </div>
          <div id="calWeeks"></div>
        </div>

        <div style="margin-top:10px;font-size:12px;font-weight:900;opacity:.75;">
          · 월요일 시작 · "1일이 포함된 주 = 그 달 1주" 규칙 적용 · 주(가로줄) 클릭하면 선택됨
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn" id="applyCal" type="button">선택 적용</button>
      </div>
    </div>
  </div>

  <!-- 공지 모달 -->
  <div class="backdrop" id="noticeBackdrop" aria-modal="true" role="dialog">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span class="pill">공지</span></div>
        <button class="btn" id="closeNotice" type="button">닫기</button>
      </div>
      <div class="modal-body" style="line-height:1.5;font-weight:900;">
        <div style="margin-bottom:10px;">✅ 현재 버전은 <b>Windows 11</b> 및 <b>Android(Chrome)</b> 환경에 최적화되어 있습니다.</div>
        <div style="opacity:.75;font-size:12px;">
          · 인쇄 시 브라우저 인쇄 설정에서 “배경 그래픽(배경색/이미지)”를 켜면 색상이 그대로 출력됩니다.<br>
          · (참고) iPhone/iOS는 추후 별도 모드 지원을 고려합니다.
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" id="okNotice" type="button">확인</button>
      </div>
    </div>
  </div>

  <!-- 가져오기용 -->
  <input id="importFile" type="file" accept="application/json" style="display:none;" />

  <script>
    // ===== 시간/요일 =====
    const times = [
      "06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00",
      "16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00","00:00","01:00"
    ];
    const days = ["월","화","수","목","금","토","일"];

    // ===== storage =====
    const STORAGE_TITLE_KEY = "planner_custom_title";
    const STORAGE_TITLE_EDIT_KEY = "planner_title_edit_on";

    const STORAGE_DATE_LINK_KEY = "planner_date_link_enabled";
    const STORAGE_MW_KEY = "planner_monthweek"; // "YYYY-MM-Wn" e.g. 2026-02-W3

    const STORAGE_ORIENTATION_KEY = "planner_print_orientation";

    const STORAGE_DAYW_KEY = "planner_dayW";
    const STORAGE_ROWH_KEY = "planner_rowH";

    const STORAGE_ALL_VERSION = "planner_v5";

    // 데이터(테마 단일로 간단화)
    const STORAGE_DATA_KEY = "planner_data";

    // ===== DOM =====
    const rowsEl = document.getElementById("rows");
    const plannerTitleText = document.getElementById("plannerTitleText");
    const plannerMetaText  = document.getElementById("plannerMetaText");
    const titleInput       = document.getElementById("titleInput");
    const titleEdit        = document.getElementById("titleEdit");
    const titleEditToggle  = document.getElementById("titleEditToggle");
    const titleSwitch      = document.getElementById("titleSwitch");

    const dateLinkToggle   = document.getElementById("dateLinkToggle");
    const dateSwitch       = document.getElementById("dateSwitch");

    const pickWeekBtn      = document.getElementById("pickWeekBtn");

    const orientationSelect = document.getElementById("orientationSelect");
    const printBtn          = document.getElementById("printBtn");

    const resetSizeBtn      = document.getElementById("resetSizeBtn");
    const resetAllBtn       = document.getElementById("resetAllBtn");

    const colResize         = document.getElementById("colResize");
    const rowResize         = document.getElementById("rowResize");

    const plannerTable      = document.getElementById("plannerTable");

    // memo modal
    const memoBackdrop = document.getElementById("memoBackdrop");
    const memoText = document.getElementById("memoText");
    const pillTime = document.getElementById("pillTime");
    const pillDay  = document.getElementById("pillDay");
    const closeMemo = document.getElementById("closeMemo");
    const saveMemoBtn = document.getElementById("saveMemo");
    const clearCellBtn = document.getElementById("clearCellBtn");

    // calendar modal
    const calBackdrop = document.getElementById("calBackdrop");
    const calLabel = document.getElementById("calLabel");
    const calPrev = document.getElementById("calPrev");
    const calNext = document.getElementById("calNext");
    const calToday = document.getElementById("calToday");
    const calWeeks = document.getElementById("calWeeks");
    const closeCal = document.getElementById("closeCal");
    const applyCal = document.getElementById("applyCal");
    const mwBadge = document.getElementById("mwBadge");

    // notice modal
    const noticeBackdrop = document.getElementById("noticeBackdrop");
    const noticeBtn = document.getElementById("noticeBtn");
    const closeNotice = document.getElementById("closeNotice");
    const okNotice = document.getElementById("okNotice");

    // import/export
    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const importFile = document.getElementById("importFile");

    let activeCell = null;
    let calYear = (new Date()).getFullYear();
    let calMonth = (new Date()).getMonth()+1; // 1-12
    let selectedMonday = null; // calendar selection

    // ===== utils =====
    function setSwitchVisual(wrapper, checked){
      wrapper.classList.toggle("on", checked);
    }
    function pad2(n){ return String(n).padStart(2,"0"); }
    function cellId(r,c){ return `${r}-${c}`; }

    function getData(){
      try { return JSON.parse(localStorage.getItem(STORAGE_DATA_KEY) || "{}"); }
      catch { return {}; }
    }
    function setData(obj){
      localStorage.setItem(STORAGE_DATA_KEY, JSON.stringify(obj));
    }

    function fmtKoreanDate(d){
      return `${d.getMonth()+1}월 ${d.getDate()}일`;
    }

    // Monday-based
    function getMondayFromDate(d){
      const date = new Date(d);
      const dow = (date.getDay()+6)%7; // Mon=0
      date.setDate(date.getDate()-dow);
      date.setHours(0,0,0,0);
      return date;
    }

    // "1일 포함 주 = 그달 1주" -> week1 Monday
    function getMonthWeek1Monday(year, month1to12){
      const first = new Date(year, month1to12-1, 1);
      return getMondayFromDate(first);
    }
    function getMonthWeekCount(year, month1to12){
      const week1Mon = getMonthWeek1Monday(year, month1to12);
      const last = new Date(year, month1to12, 0);
      const lastMon = getMondayFromDate(last);
      const diffDays = Math.round((lastMon-week1Mon)/(1000*60*60*24));
      return Math.floor(diffDays/7)+1;
    }
    function monthWeekNoFromMonday(year, month1to12, monday){
      const week1Mon = getMonthWeek1Monday(year, month1to12);
      const diffDays = Math.round((monday-week1Mon)/(1000*60*60*24));
      return Math.floor(diffDays/7)+1;
    }

    // ===== render grid =====
    function renderGrid(){
      rowsEl.innerHTML = times.map((t, r)=>`
        <tr>
          <td class="time">${t}</td>
          ${Array.from({length:7}).map((_, c)=>
            `<td class="cell empty" data-r="${r}" data-c="${c}"><div class="preview"></div></td>`
          ).join("")}
        </tr>
      `).join("");
    }
    renderGrid();

    function updateCellDisplay(td, value){
      td.querySelector(".preview").textContent = value || "";
      td.classList.toggle("empty", !value || value.trim()==="");
    }

    function loadAllCells(){
      const data = getData();
      document.querySelectorAll("td.cell").forEach(td=>{
        const r = td.dataset.r, c = td.dataset.c;
        updateCellDisplay(td, data[cellId(r,c)] || "");
      });
    }
    function saveCellValue(r,c,value){
      const data = getData();
      const id = cellId(r,c);
      const v = (value ?? "").replace(/\s+$/,"");
      if(v.trim()==="") delete data[id];
      else data[id] = v;
      setData(data);

      const td = document.querySelector(`td.cell[data-r="${r}"][data-c="${c}"]`);
      if(td) updateCellDisplay(td, v);
    }

    // ===== memo modal =====
    function openMemo(td){
      const r = Number(td.dataset.r);
      const c = Number(td.dataset.c);
      activeCell = { r, c, td };

      const data = getData();
      const value = data[cellId(r,c)] || "";

      pillTime.textContent = times[r];
      pillDay.textContent = days[c];

      memoText.value = value;
      memoBackdrop.style.display = "flex";
      setTimeout(()=>memoText.focus(), 50);
    }
    function closeMemoModal(){
      memoBackdrop.style.display = "none";
      activeCell = null;
    }
    rowsEl.addEventListener("click", (e)=>{
      const td = e.target.closest("td.cell");
      if(td) openMemo(td);
    });
    saveMemoBtn.addEventListener("click", ()=>{
      if(!activeCell) return;
      saveCellValue(activeCell.r, activeCell.c, memoText.value);
      closeMemoModal();
    });
    clearCellBtn.addEventListener("click", ()=>{
      if(!activeCell) return;
      memoText.value = "";
      saveCellValue(activeCell.r, activeCell.c, "");
      closeMemoModal();
    });
    closeMemo.addEventListener("click", closeMemoModal);
    memoBackdrop.addEventListener("click", (e)=>{
      if(e.target === memoBackdrop) closeMemoModal();
    });

    // ===== title =====
    function applyTitleFromStorage(){
      const saved = (localStorage.getItem(STORAGE_TITLE_KEY) || "").trim();
      // ✅ 저장된 게 없으면 무조건 "주간 플래너"
      plannerTitleText.textContent = saved ? saved : "주간 플래너";
      titleInput.value = saved;
    }

    function initTitle(){
      applyTitleFromStorage();
      const editOn = localStorage.getItem(STORAGE_TITLE_EDIT_KEY)==="1";
      titleEditToggle.checked = editOn;
      setSwitchVisual(titleSwitch, editOn);
      titleEdit.classList.toggle("show", editOn);
    }

    titleInput.addEventListener("input", ()=>{
      localStorage.setItem(STORAGE_TITLE_KEY, titleInput.value);
      applyTitleFromStorage();
    });

    titleSwitch.addEventListener("click", ()=>{
      const next = !titleEditToggle.checked;
      titleEditToggle.checked = next;
      localStorage.setItem(STORAGE_TITLE_EDIT_KEY, next ? "1":"0");
      setSwitchVisual(titleSwitch, next);
      titleEdit.classList.toggle("show", next);
    });

    // ===== date link (header dates) =====
    function clearHeaderDates(){
      document.querySelectorAll(".date[data-dow]").forEach(el=> el.textContent="");
      plannerMetaText.textContent = "";
    }

    function applyWeekMonday(monday){
      const start = new Date(monday);
      const end = new Date(monday); end.setDate(monday.getDate()+6);

      document.querySelectorAll(".date[data-dow]").forEach(el=>{
        const i = Number(el.dataset.dow);
        const d = new Date(monday);
        d.setDate(monday.getDate()+i);
        el.textContent = `(${fmtKoreanDate(d)})`;
      });

      plannerMetaText.textContent = `기간: ${fmtKoreanDate(start)} ~ ${fmtKoreanDate(end)}`;

      // 자동 제목: 사용자가 제목을 직접 넣지 않았을 때만
      const custom = (localStorage.getItem(STORAGE_TITLE_KEY) || "").trim();
      if(!custom){
        // 규칙상: 선택 달력의 "표시 월" 기준으로 몇 주인지
        const y = calYear, m = calMonth;
        const w = monthWeekNoFromMonday(y,m,monday);
        const auto = `${m}월 ${w}주 플래너(${fmtKoreanDate(start)} ~ ${fmtKoreanDate(end)})`;
        localStorage.setItem(STORAGE_TITLE_KEY, auto);
        applyTitleFromStorage();
      }
    }

    function enableDateLink(enable){
      dateLinkToggle.checked = enable;
      setSwitchVisual(dateSwitch, enable);
      localStorage.setItem(STORAGE_DATE_LINK_KEY, enable ? "1":"0");
      if(!enable){
        clearHeaderDates();
        // ✅ 제목은 절대 안 지움
        applyTitleFromStorage();
      }else{
        // 저장된 monthweek가 있으면 달력에 반영
        const saved = localStorage.getItem(STORAGE_MW_KEY);
        if(saved){
          const [sy, sm, sw] = saved.split("-");
          calYear = Number(sy);
          calMonth = Number(sm);
          const w = Number(sw.replace("W",""));
          const monday = getMonthWeek1Monday(calYear, calMonth);
          const selected = new Date(monday);
          selected.setDate(monday.getDate() + (w-1)*7);
          selectedMonday = selected;
          applyWeekMonday(selectedMonday);
        }
      }
    }

    dateSwitch.addEventListener("click", ()=>{
      enableDateLink(!dateLinkToggle.checked);
    });

    function initDateLink(){
      const enabled = localStorage.getItem(STORAGE_DATE_LINK_KEY)==="1";
      enableDateLink(enabled);
    }

    // ===== calendar UI =====
    function openCal(){
      calBackdrop.style.display = "flex";
      renderCalendar(calYear, calMonth);
    }
    function closeCalModal(){
      calBackdrop.style.display = "none";
    }

    function renderCalendar(year, month1to12){
      calLabel.textContent = `${year}년 ${month1to12}월`;
      const weekCount = getMonthWeekCount(year, month1to12);
      mwBadge.textContent = `총 ${weekCount}주`;

      // 표시 시작: week1 Monday
      const startMon = getMonthWeek1Monday(year, month1to12);

      calWeeks.innerHTML = "";
      for(let w=1; w<=weekCount; w++){
        const monday = new Date(startMon);
        monday.setDate(startMon.getDate() + (w-1)*7);

        const weekEl = document.createElement("div");
        weekEl.className = "cal-week";
        weekEl.dataset.monday = monday.toISOString();

        for(let i=0;i<7;i++){
          const d = new Date(monday);
          d.setDate(monday.getDate()+i);

          const inMonth = (d.getMonth()+1) === month1to12;
          const cell = document.createElement("div");
          cell.className = "cal-cell" + (inMonth ? "" : " out") + (i===5 ? " sat" : "") + (i===6 ? " sun" : "");
          cell.innerHTML = `<div class="d">${d.getDate()}</div><div class="m">${d.getMonth()+1}월</div>`;
          weekEl.appendChild(cell);
        }

        // 선택 표시
        if(selectedMonday && getMondayFromDate(selectedMonday).getTime() === monday.getTime()){
          weekEl.style.outline = `3px solid var(--calAccent)`;
          weekEl.style.borderRadius = "10px";
        }

        weekEl.addEventListener("click", ()=>{
          selectedMonday = new Date(weekEl.dataset.monday);
          // 다시 그려서 선택 강조
          renderCalendar(year, month1to12);
          const label = `${year}년 ${month1to12}월 ${w}주`;
          mwBadge.textContent = `선택: ${label}`;
        });

        calWeeks.appendChild(weekEl);
      }
    }

    pickWeekBtn.addEventListener("click", ()=>{
      if(!dateLinkToggle.checked){
        // 날짜연동 꺼져 있으면 먼저 켜고 달력 열기
        enableDateLink(true);
      }
      openCal();
    });

    calPrev.addEventListener("click", ()=>{
      calMonth--;
      if(calMonth<1){ calMonth=12; calYear--; }
      renderCalendar(calYear, calMonth);
    });
    calNext.addEventListener("click", ()=>{
      calMonth++;
      if(calMonth>12){ calMonth=1; calYear++; }
      renderCalendar(calYear, calMonth);
    });
    calToday.addEventListener("click", ()=>{
      const now = new Date();
      calYear = now.getFullYear();
      calMonth = now.getMonth()+1;
      renderCalendar(calYear, calMonth);
    });

    applyCal.addEventListener("click", ()=>{
      if(!selectedMonday){
        alert("주를 선택해줘!");
        return;
      }
      // 현재 달력 month 기준 week 번호 계산해서 저장
      const w = monthWeekNoFromMonday(calYear, calMonth, getMondayFromDate(selectedMonday));
      localStorage.setItem(STORAGE_MW_KEY, `${calYear}-${pad2(calMonth)}-W${w}`);
      enableDateLink(true);
      applyWeekMonday(getMondayFromDate(selectedMonday));
      closeCalModal();
    });

    closeCal.addEventListener("click", closeCalModal);
    calBackdrop.addEventListener("click", (e)=>{
      if(e.target === calBackdrop) closeCalModal();
    });

    // ===== orientation/print =====
    function applyOrientation(value){
      document.documentElement.style.setProperty("--paper", value);
      localStorage.setItem(STORAGE_ORIENTATION_KEY, value);
    }
    function initOrientation(){
      const saved = localStorage.getItem(STORAGE_ORIENTATION_KEY) || "portrait";
      orientationSelect.value = saved;
      applyOrientation(saved);
    }
    orientationSelect.addEventListener("change", ()=>{
      applyOrientation(orientationSelect.value);
    });

    // ✅ 인쇄 잘림 방지 핵심: beforeprint에서 A4 인쇄영역(px)으로 스케일 계산
    // (Windows/Android Chrome/Edge에서 효과 좋음)
    function mmToPx(mm){ return mm * (96/25.4); }

    function computePrintScale(){
      const paper = getComputedStyle(document.documentElement).getPropertyValue("--paper").trim() || "portrait";
      const marginMm = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--printMargin")) || 8;

      const a4wMm = (paper === "landscape") ? 297 : 210;
      const a4hMm = (paper === "landscape") ? 210 : 297;

      const printableW = mmToPx(a4wMm - 2*marginMm);
      const printableH = mmToPx(a4hMm - 2*marginMm);

      // 테이블 실제 크기(px)
      const rect = plannerTable.getBoundingClientRect();
      // 제목 영역까지 포함해서 1장에 들어가도록: 카드 상단 여유 포함
      const titleRect = document.querySelector(".title-row").getBoundingClientRect();

      const contentW = rect.width;
      const contentH = rect.height + titleRect.height + 12; // 약간의 여유

      const scaleW = printableW / contentW;
      const scaleH = printableH / contentH;

      // 너무 작아지지 않게 하되, 잘림 방지가 우선이라 min 사용
      let scale = Math.min(scaleW, scaleH);
      scale = Math.min(scale, 1);        // 확대는 안 함(깨짐 방지)
      scale = Math.max(scale, 0.58);     // 너무 작으면 글씨 못 봄 방지(필요시 조정)

      document.documentElement.style.setProperty("--printScale", String(scale));
    }

    window.addEventListener("beforeprint", ()=>{
      computePrintScale();
    });

    printBtn.addEventListener("click", ()=>{
      alert("색상 배경이 그대로 나오려면 인쇄 설정에서 '배경 그래픽(배경색/이미지)'을 켜줘!");
      computePrintScale();
      window.print();
    });

    // ===== resize (uniform) =====
    function px(n){ return `${Math.round(n)}px`; }

    function initSizeFromStorage(){
      const dayW = localStorage.getItem(STORAGE_DAYW_KEY);
      const rowH = localStorage.getItem(STORAGE_ROWH_KEY);
      if(dayW) document.documentElement.style.setProperty("--dayW", dayW);
      if(rowH) document.documentElement.style.setProperty("--rowH", rowH);
    }

    function startDrag(el, axis){
      let startX=0, startY=0, startVal=0;

      function onDown(e){
        e.preventDefault();
        const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
        startX = p.clientX;
        startY = p.clientY;

        if(axis === "col"){
          const ths = document.querySelectorAll("table.planner thead th");
          startVal = ths[1].getBoundingClientRect().width;
        }else{
          const td = document.querySelector("table.planner td.time");
          startVal = td.getBoundingClientRect().height;
        }

        window.addEventListener("mousemove", onMove, {passive:false});
        window.addEventListener("mouseup", onUp);
        window.addEventListener("touchmove", onMove, {passive:false});
        window.addEventListener("touchend", onUp);
      }

      function onMove(e){
        e.preventDefault();
        const p = (e.touches && e.touches[0]) ? e.touches[0] : e;

        if(axis === "col"){
          const dx = p.clientX - startX;
          let next = startVal + dx;
          next = Math.max(90, Math.min(260, next));
          const val = px(next);
          document.documentElement.style.setProperty("--dayW", val);
          localStorage.setItem(STORAGE_DAYW_KEY, val);
        }else{
          const dy = p.clientY - startY;
          let next = startVal + dy;
          next = Math.max(28, Math.min(90, next));
          const val = px(next);
          document.documentElement.style.setProperty("--rowH", val);
          localStorage.setItem(STORAGE_ROWH_KEY, val);
        }
      }

      function onUp(){
        window.removeEventListener("mousemove", onMove);
        window.removeEventListener("mouseup", onUp);
        window.removeEventListener("touchmove", onMove);
        window.removeEventListener("touchend", onUp);
      }

      el.addEventListener("mousedown", onDown);
      el.addEventListener("touchstart", onDown, {passive:false});
    }

    startDrag(colResize, "col");
    startDrag(rowResize, "row");

    // ===== reset buttons =====
    resetSizeBtn.addEventListener("click", ()=>{
      const ok = confirm("가로/세로 칸 크기를 기본값으로 초기화할까?");
      if(!ok) return;
      localStorage.removeItem(STORAGE_DAYW_KEY);
      localStorage.removeItem(STORAGE_ROWH_KEY);
      document.documentElement.style.setProperty("--dayW", "140px");
      document.documentElement.style.setProperty("--rowH", "36px");
      alert("크기 초기화 완료!");
    });

    resetAllBtn.addEventListener("click", ()=>{
      const ok = confirm("⚠️ 전체 초기화하면 입력한 내용/설정이 모두 삭제돼.\n정말 초기화할까?");
      if(!ok) return;

      // 전체 키 삭제(안전하게 필요한 것만)
      localStorage.removeItem(STORAGE_DATA_KEY);
      localStorage.removeItem(STORAGE_TITLE_KEY);
      localStorage.removeItem(STORAGE_TITLE_EDIT_KEY);
      localStorage.removeItem(STORAGE_DATE_LINK_KEY);
      localStorage.removeItem(STORAGE_MW_KEY);
      localStorage.removeItem(STORAGE_ORIENTATION_KEY);
      localStorage.removeItem(STORAGE_DAYW_KEY);
      localStorage.removeItem(STORAGE_ROWH_KEY);

      // 화면 리셋
      document.documentElement.style.setProperty("--dayW", "140px");
      document.documentElement.style.setProperty("--rowH", "36px");
      document.documentElement.style.setProperty("--paper", "portrait");
      document.documentElement.style.setProperty("--printScale", "1");

      // 다시 초기화
      initTitle();
      initOrientation();
      initDateLink();
      loadAllCells();

      alert("전체 초기화 완료!");
    });

    // ===== notice =====
    function openNotice(){ noticeBackdrop.style.display="flex"; }
    function closeNoticeModal(){ noticeBackdrop.style.display="none"; }
    noticeBtn.addEventListener("click", openNotice);
    closeNotice.addEventListener("click", closeNoticeModal);
    okNotice.addEventListener("click", closeNoticeModal);
    noticeBackdrop.addEventListener("click", (e)=>{ if(e.target===noticeBackdrop) closeNoticeModal(); });

    // ===== export/import =====
    exportBtn.addEventListener("click", ()=>{
      const payload = {
        app: "pasteltone-weekly-planner",
        version: 5,
        exportedAt: new Date().toISOString(),
        settings: {
          title: localStorage.getItem(STORAGE_TITLE_KEY) || "",
          titleEditOn: localStorage.getItem(STORAGE_TITLE_EDIT_KEY) || "0",
          dateLinkEnabled: localStorage.getItem(STORAGE_DATE_LINK_KEY) || "0",
          monthWeek: localStorage.getItem(STORAGE_MW_KEY) || "",
          orientation: localStorage.getItem(STORAGE_ORIENTATION_KEY) || "portrait",
          dayW: localStorage.getItem(STORAGE_DAYW_KEY) || "",
          rowH: localStorage.getItem(STORAGE_ROWH_KEY) || "",
        },
        data: getData()
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const d = new Date();
      a.href = url;
      a.download = `weekly_planner_backup_${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener("click", ()=>{
      importFile.value = "";
      importFile.click();
    });

    importFile.addEventListener("change", async ()=>{
      const file = importFile.files?.[0];
      if(!file) return;

      try{
        const text = await file.text();
        const json = JSON.parse(text);
        if(!json || typeof json !== "object" || !json.data){
          alert("형식이 올바르지 않은 JSON이야.");
          return;
        }

        const ok = confirm("가져오면 현재 저장된 내용이 덮어쓰기될 수 있어. 진행할까?");
        if(!ok) return;

        setData(json.data);

        if(json.settings){
          localStorage.setItem(STORAGE_TITLE_KEY, json.settings.title || "");
          localStorage.setItem(STORAGE_TITLE_EDIT_KEY, json.settings.titleEditOn || "0");
          localStorage.setItem(STORAGE_DATE_LINK_KEY, json.settings.dateLinkEnabled || "0");
          localStorage.setItem(STORAGE_MW_KEY, json.settings.monthWeek || "");
          localStorage.setItem(STORAGE_ORIENTATION_KEY, json.settings.orientation || "portrait");

          if(json.settings.dayW) localStorage.setItem(STORAGE_DAYW_KEY, json.settings.dayW);
          if(json.settings.rowH) localStorage.setItem(STORAGE_ROWH_KEY, json.settings.rowH);
        }

        initSizeFromStorage();
        initTitle();
        initOrientation();
        initDateLink();
        loadAllCells();

        alert("가져오기 완료!");
      }catch(err){
        alert("가져오기 실패! 파일이 손상됐거나 JSON이 아니야.");
      }
    });

    // ===== init =====
    function renderHeaderAndRows(){
      // rows already rendered; just load
      loadAllCells();
    }

    function initSwitchVisuals(){
      setSwitchVisual(dateSwitch, dateLinkToggle.checked);
      setSwitchVisual(titleSwitch, titleEditToggle.checked);
    }

    function initOrientation(){
      const saved = localStorage.getItem(STORAGE_ORIENTATION_KEY) || "portrait";
      orientationSelect.value = saved;
      applyOrientation(saved);
    }

    function initTitle(){
      applyTitleFromStorage();
      const editOn = localStorage.getItem(STORAGE_TITLE_EDIT_KEY)==="1";
      titleEditToggle.checked = editOn;
      setSwitchVisual(titleSwitch, editOn);
      titleEdit.classList.toggle("show", editOn);
    }

    function initDateLink(){
      const enabled = localStorage.getItem(STORAGE_DATE_LINK_KEY)==="1";
      enableDateLink(enabled);
    }

    // title always present
    initSizeFromStorage();
    initTitle();
    initOrientation();
    initDateLink();
    initSwitchVisuals();
    renderHeaderAndRows();
  </script>
</body>
</html>
