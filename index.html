<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>파스텔톤 주간 플래너</title>

  <!-- FAVICON (같은 폴더에 두는 기준) -->
  <link rel="icon" href="./PWP7_favicon_ultra.ico" sizes="any">
  <link rel="icon" type="image/png" href="./PWP7_favicon_ultra.png">

  <style>
    :root{
      --bg:#eef6ff;
      --border:#bcd3f5;
      --header:#d9e8ff;
      --timebg:#f4f9ff;
      --text:#111;

      --sat:#1565c0;
      --sun:#c62828;

      --timeW:110px;
      --dayW:140px;
      --rowH:36px;

      --paper: portrait; /* portrait | landscape */
      --printMargin: 5mm;

      --sel:#111;
      --selGlow: color-mix(in srgb, var(--border) 55%, transparent 45%);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: "Malgun Gothic", Arial, sans-serif;
      color:var(--text);
      background: var(--bg);
    }

    /* ===== appbar ===== */
    .appbar{
      position: sticky;
      top: 0;
      z-index: 60;
      backdrop-filter: blur(10px);
      background: color-mix(in srgb, var(--bg) 78%, white 22%);
      border-bottom: 1px solid var(--border);
    }
    .appbar-inner{
      max-width: 1180px;
      margin: 0 auto;
      padding: 10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
    }
    .left, .right{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
    }
    .brand{
      font-weight: 1000;
      font-size: 15px;
      letter-spacing: -0.2px;
      white-space: nowrap;
      cursor: default;
    }
    .hint{
      font-size: 12px;
      opacity: 0.72;
      white-space: nowrap;
    }

    .btn, .select{
      border: 1px solid var(--border);
      background: white;
      padding: 7px 10px;
      border-radius: 10px;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{ opacity: 1; }
    .btn.ghost{
      background: transparent;
      border: 1px dashed var(--border);
    }
    .btn.danger{
      border-color: #ff6b6b;
      color: #b00020;
      background: #fff5f5;
    }
    .btn.danger:hover{ background:#ffecec; }

    /* pretty switch */
    .switch{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, white 70%, var(--bg) 30%);
      font-weight: 900;
      font-size: 13px;
      user-select:none;
      cursor:pointer;
    }
    .switch input{ display:none; }
    .track{
      width: 38px; height: 22px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      position: relative;
      flex: 0 0 auto;
    }
    .knob{
      width: 18px; height: 18px;
      border-radius: 999px;
      background: color-mix(in srgb, var(--border) 55%, #fff 45%);
      position:absolute;
      top: 1px; left: 1px;
      transition: left .18s ease, background .18s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,.12);
    }
    .switch.on .track{ background: color-mix(in srgb, var(--header) 65%, #fff 35%); }
    .switch.on .knob{
      left: 19px;
      background: color-mix(in srgb, var(--border) 85%, #fff 15%);
    }

    /* ===== layout ===== */
    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px 12px 30px;
    }
    .card{
      background: color-mix(in srgb, var(--bg) 75%, #fff 25%);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }

    .title-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .titleBox{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      font-weight: 1000;
      font-size: 18px;
      letter-spacing: -0.2px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 10px 22px rgba(0,0,0,.05);
    }
    .titleBox:hover{ opacity:.95; }
    .titleSub{
      margin-top: 6px;
      font-size: 12px;
      font-weight: 900;
      opacity: .75;
      min-height: 14px;
    }

    .table-wrap{
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
      background: #fff;
    }

    table.planner{
      width: 100%;
      min-width: 860px;
      border-collapse: collapse;
      table-layout: fixed;
      background:#fff;

      border: 1px solid var(--border);
      border-right: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    col.timecol{ width: var(--timeW); }
    col.daycol{ width: var(--dayW); }

    .planner th, .planner td{
      border: 1px solid var(--border);
      text-align: center;
      vertical-align: middle;
      height: var(--rowH);
      padding: 6px 6px;
      font-size: 14px;
    }

    .planner tr > *:last-child{
      border-right: 1px solid var(--border) !important;
    }

    .planner thead th{
      background: var(--header);
      font-weight: 900;
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .planner td.time{
      background: var(--timebg);
      font-weight: 900;
      position: sticky;
      left: 0;
      z-index: 4;
    }

    /* corner diagonal */
    .planner th.corner{
      position: sticky;
      top: 0;
      left: 0;
      z-index: 6;
      padding: 0;
      background: var(--header);
      min-height: 44px;
    }
    .cornerBox{
      position: relative;
      width: 100%;
      height: 100%;
    }
    .cornerBox::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        linear-gradient(135deg,
          transparent 49.7%,
          color-mix(in srgb, var(--border) 92%, #fff 8%) 50%,
          transparent 50.3%);
      pointer-events:none;
    }
    .cornerTime{
      position:absolute;
      left: 10px;
      bottom: 6px;
      font-weight: 1000;
      font-size: 13px;
    }
    .cornerDay{
      position:absolute;
      right: 10px;
      top: 6px;
      font-weight: 1000;
      font-size: 13px;
    }

    /* header day + date */
    .dow{
      display:flex;
      flex-direction: column;
      gap: 2px;
      line-height: 1.05;
      align-items:center;
      justify-content:center;
      min-height: 36px;
    }
    .dow .name{ font-weight: 1000; }
    .dow .date{
      font-size: 11px;
      opacity: .7;
      font-weight: 1000;
      min-height: 12px;
    }
    .no-date .dow{ justify-content:center; }
    .no-date .dow .date{ display:none; }

    .sat .name, .sat .date{ color: var(--sat); opacity: .95; }
    .sun .name, .sun .date{ color: var(--sun); opacity: .95; }

    /* ✅ 셀: 기본은 "맨 윗줄(핵심)"만 보이게 + 길면 ... */
    .planner td.cell{
      cursor: pointer;
      text-align: left;
      padding: 6px 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      background: #fff;
      position: relative;
    }
    .planner td.cell:hover{
      background: color-mix(in srgb, var(--header) 18%, white 82%);
    }
    .planner td.cell.empty::before{
      content: "클릭해서 입력";
      opacity: .25;
    }

    /* 펼치기(옵션): 더블탭/화살표로 토글 */
    .planner td.cell.expanded{
      white-space: pre-wrap;
      overflow: visible;
      text-overflow: clip;
    }
    .expander{
      position:absolute;
      right: 6px;
      bottom: 6px;
      width: 18px;
      height: 18px;
      border-radius: 8px;
      display:none;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      font-size: 12px;
      border: 1px solid var(--border);
      background: #fff;
      opacity:.92;
    }
    .planner td.cell.hasMore .expander{ display:flex; }
    .planner td.cell.hasMore:not(.expanded) .expander::before{ content:"▾"; }
    .planner td.cell.hasMore.expanded .expander::before{ content:"▴"; }

    /* 선택된 셀(키보드/조이스틱 이동) */
    .planner td.cell.selected{
      outline: 2px solid var(--sel);
      outline-offset: -2px;
      box-shadow: 0 0 0 4px var(--selGlow) inset;
    }

    /* ===== tooltip preview ===== */
    .tooltip{
      position: fixed;
      z-index: 9999;
      max-width: min(520px, calc(100vw - 28px));
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 14px 45px rgba(0,0,0,.22);
      white-space: pre-wrap;
      word-break: break-word;
      font-weight: 900;
      font-size: 13px;
      display:none;
      pointer-events:none;
    }
    .tooltip .meta{
      font-size: 11px;
      opacity:.7;
      font-weight: 1000;
      margin-bottom: 6px;
    }

    /* ===== modal common ===== */
    .backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 100;
      padding: 14px;
    }
    .modal{
      width: min(780px, 100%);
      background: #fff;
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      overflow: hidden;
    }
    .modal-header{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      background: color-mix(in srgb, var(--bg) 75%, #fff 25%);
      border-bottom: 1px solid var(--border);
    }
    .modal-title{
      font-weight: 1000;
      font-size: 14px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
    }
    .pill{
      display:inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 12px;
      font-weight: 1000;
      opacity: .92;
    }
    .pill.soft{
      background: color-mix(in srgb, var(--header) 25%, #fff 75%);
    }
    .modal-body{ padding: 12px; }
    .modal-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      padding: 12px;
      border-top: 1px solid var(--border);
      flex-wrap: wrap;
    }

    textarea, input[type="text"]{
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px;
      font-size: 14px;
      line-height: 1.4;
      outline: none;
      font-weight: 900;
    }
    textarea{ min-height: 120px; resize: vertical; }
    textarea:focus, input[type="text"]:focus{
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--border) 50%, transparent 50%);
    }

    /* ===== calendar ===== */
    .cal-head{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .cal-head .nav{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
    }
    .cal-grid{
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow:hidden;
    }
    .cal-dow{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
    }
    .cal-dow div{
      background: color-mix(in srgb, var(--header) 75%, #fff 25%);
      border-bottom: 1px solid var(--border);
      padding: 8px 6px;
      text-align:center;
      font-weight: 1000;
      font-size: 13px;
    }
    .cal-dow .sat{ color: var(--sat); }
    .cal-dow .sun{ color: var(--sun); }

    .cal-week{
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      border-bottom: 1px solid var(--border);
      cursor:pointer;
      background:#fff;
      transition: background .12s ease, transform .12s ease;
    }
    .cal-week:last-child{ border-bottom:none; }
    .cal-week:hover{
      background: color-mix(in srgb, var(--header) 18%, #fff 82%);
      transform: translateY(-1px);
    }
    .cal-week.selected{
      outline: 3px solid color-mix(in srgb, var(--border) 60%, #fff 40%);
      border-radius: 10px;
      overflow: hidden;
    }
    .cal-cell{
      padding: 10px 6px;
      text-align:center;
      border-right: 1px solid var(--border);
      font-weight: 900;
      min-height: 44px;
      display:flex;
      flex-direction: column;
      justify-content:center;
      gap:2px;
    }
    .cal-cell:last-child{ border-right:none; }
    .cal-cell .d{ font-size: 14px; }
    .cal-cell .m{ font-size: 11px; opacity: .7; font-weight: 1000; }
    .cal-cell.out{ opacity: .35; }
    .cal-cell.sat{ color: var(--sat); }
    .cal-cell.sun{ color: var(--sun); }

    /* ===== mobile joystick ===== */
    .joy-fab{
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 80;
      width: 52px;
      height: 52px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: #fff;
      box-shadow: 0 18px 45px rgba(0,0,0,.22);
      display:none;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      cursor:pointer;
      user-select:none;
    }
    .joy-fab::before{ content:"⌖"; font-size: 18px; }
    .joy-pad{
      position: fixed;
      right: 14px;
      bottom: 74px;
      z-index: 80;
      width: 170px;
      padding: 10px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: color-mix(in srgb, #fff 85%, var(--bg) 15%);
      box-shadow: 0 18px 45px rgba(0,0,0,.22);
      display:none;
    }
    .joy-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      align-items:center;
      justify-items:center;
    }
    .joy-btn{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      font-weight: 1000;
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .joy-btn:active{ transform: scale(.98); }
    .joy-close{
      margin-top: 8px;
      width: 100%;
      border-radius: 12px;
      padding: 10px;
      border: 1px dashed var(--border);
      background: transparent;
      font-weight: 1000;
      cursor:pointer;
    }

    /* ===== PRINT ===== */
    @media print{
      body{
        background:#fff;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      @page{
        size: A4 var(--paper);
        margin: var(--printMargin);
      }

      .appbar, .tooltip, .joy-fab, .joy-pad{ display:none !important; }
      .wrap{ max-width: none; padding: 0; margin: 0; }
      .card{ border:none; border-radius:0; padding:0; background:#fff; }

      .table-wrap{ overflow: visible !important; border-radius:0; }

      table.planner{
        min-width: 0 !important;
        width: 100% !important;
        border-radius: 0;
      }

      /* sticky 제거 */
      .planner thead th,
      .planner td.time,
      .planner th.corner{
        position: static !important;
      }

      html[data-paper="portrait"]{ --rowH: 26px; }
      html[data-paper="landscape"]{ --rowH: 22px; }

      .planner th, .planner td{
        padding: 4px 5px !important;
        font-size: 12px !important;
      }
      .dow .date{ font-size: 10px !important; }
      .cornerTime, .cornerDay{ font-size: 12px !important; }

      /* 인쇄는 한 줄만(핵심) */
      .planner td.cell{
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }
      .expander{ display:none !important; }
      .planner td.cell.selected{ outline: none !important; box-shadow:none !important; }
    }

    @media (max-width: 520px){
      .hint{ display:none; }
      .joy-fab{ display:flex; } /* 모바일에서 조이스틱 버튼 */
    }
  </style>
</head>

<body>
  <header class="appbar">
    <div class="appbar-inner">
      <div class="left">
        <div class="brand">파스텔톤 주간 플래너</div>
        <div class="hint">Ctrl+Enter 저장 · 방향키로 이동 · 모바일은 ⌖</div>

        <button class="btn" id="noticeBtn" type="button">공지</button>

        <select class="select" id="themeSelect" title="테마">
          <option value="pink">분홍</option>
          <option value="peach">연주황</option>
          <option value="lemon">연노랑</option>
          <option value="mint">민트</option>
          <option value="lblue" selected>라이트 블루</option>
          <option value="violet">바이올렛</option>
          <option value="ivory">아이보리</option>
        </select>

        <label class="switch" id="dateSwitch" title="날짜 연동(달력에서 주 선택)">
          <span class="track"><span class="knob"></span></span>
          <span>날짜 연동</span>
          <input type="checkbox" id="dateLinkToggle" />
        </label>

        <button class="btn" id="pickWeekBtn" type="button">주 선택</button>

        <label class="switch" id="backupSwitch" title="자동 백업(1분마다 저장, 5분 지난 건 자동 삭제)">
          <span class="track"><span class="knob"></span></span>
          <span>자동 백업</span>
          <input type="checkbox" id="backupToggle" />
        </label>
      </div>

      <div class="right">
        <select class="select" id="orientationSelect" title="인쇄 방향">
          <option value="portrait">세로(A4)</option>
          <option value="landscape">가로(A4)</option>
        </select>

        <button class="btn" id="printBtn" type="button">인쇄</button>
        <button class="btn" id="exportBtn" type="button">내보내기</button>
        <button class="btn" id="importBtn" type="button">가져오기</button>
        <button class="btn ghost" id="resetSizeBtn" type="button">크기 초기화</button>
        <button class="btn danger" id="resetAllBtn" type="button">전체 초기화</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="title-row">
        <div>
          <div class="titleBox" id="titleBox" title="클릭해서 제목 편집">
            <span id="plannerTitleText">주간 플래너</span>
            <span class="pill" style="font-size:11px;">편집</span>
          </div>
          <div class="titleSub" id="plannerMetaText"></div>
        </div>
      </div>

      <div class="table-wrap">
        <table class="planner no-date" id="plannerTable" aria-label="주간 플래너">
          <colgroup>
            <col class="timecol" />
            <col class="daycol" span="7" />
          </colgroup>

          <thead>
            <tr>
              <th class="corner">
                <div class="cornerBox">
                  <div class="cornerDay">요일</div>
                  <div class="cornerTime">시간</div>
                </div>
              </th>

              <th><div class="dow"><div class="name">월</div><div class="date" data-dow="0"></div></div></th>
              <th><div class="dow"><div class="name">화</div><div class="date" data-dow="1"></div></div></th>
              <th><div class="dow"><div class="name">수</div><div class="date" data-dow="2"></div></div></th>
              <th><div class="dow"><div class="name">목</div><div class="date" data-dow="3"></div></div></th>
              <th><div class="dow"><div class="name">금</div><div class="date" data-dow="4"></div></div></th>
              <th class="sat"><div class="dow"><div class="name">토</div><div class="date" data-dow="5"></div></div></th>
              <th class="sun"><div class="dow"><div class="name">일</div><div class="date" data-dow="6"></div></div></th>
            </tr>
          </thead>

          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- tooltip (hover/long-press preview) -->
  <div class="tooltip" id="tooltip">
    <div class="meta" id="tooltipMeta"></div>
    <div id="tooltipBody"></div>
  </div>

  <!-- mobile joystick -->
  <div class="joy-fab" id="joyFab" title="셀 선택 조이스틱"></div>
  <div class="joy-pad" id="joyPad" aria-label="조이스틱">
    <div class="joy-grid">
      <div></div>
      <div class="joy-btn" data-dir="up">▲</div>
      <div></div>

      <div class="joy-btn" data-dir="left">◀</div>
      <div class="joy-btn" data-dir="enter">⏎</div>
      <div class="joy-btn" data-dir="right">▶</div>

      <div></div>
      <div class="joy-btn" data-dir="down">▼</div>
      <div></div>
    </div>
    <button class="joy-close" id="joyClose" type="button">닫기</button>
  </div>

  <!-- ===== 셀 입력 모달 ===== -->
  <div class="backdrop" id="cellBackdrop" aria-modal="true" role="dialog">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">
          <span class="pill">내용 입력</span>
          <span class="pill soft">Enter=줄바꿈 · Ctrl+Enter=저장</span>
          <span class="pill" id="cellLabel"></span>
        </div>
        <button class="btn" id="closeCell" type="button">닫기</button>
      </div>
      <div class="modal-body">
        <textarea id="cellInput" placeholder="내용을 입력해줘 (줄바꿈 가능)"></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" id="clearCellBtn" type="button">비우기</button>
        <button class="btn" id="saveCellBtn" type="button">저장</button>
      </div>
    </div>
  </div>

  <!-- ===== 제목 편집 모달 ===== -->
  <div class="backdrop" id="titleBackdrop" aria-modal="true" role="dialog">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span class="pill">제목 편집</span></div>
        <button class="btn" id="closeTitle" type="button">닫기</button>
      </div>
      <div class="modal-body">
        <input type="text" id="titleInput" placeholder="예) 주간 플래너 / 나만의 플래너 ..." />
        <div style="margin-top:8px;font-size:12px;font-weight:900;opacity:.7;">
          · 비워두면 기본 제목 “주간 플래너”로 표시돼.
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn ghost" id="clearTitleBtn" type="button">제목 비우기</button>
        <button class="btn" id="saveTitleBtn" type="button">저장</button>
      </div>
    </div>
  </div>

  <!-- ===== 달력(주 선택) 모달 ===== -->
  <div class="backdrop" id="calBackdrop" aria-modal="true" role="dialog">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">
          <span class="pill">주 선택</span>
          <span class="pill" id="calLabel"></span>
        </div>
        <button class="btn" id="closeCal" type="button">닫기</button>
      </div>

      <div class="modal-body">
        <div class="cal-head">
          <div class="nav">
            <button class="btn" id="calPrev" type="button">◀</button>
            <button class="btn" id="calToday" type="button">이번 달</button>
            <button class="btn" id="calThisWeek" type="button">이번 주</button>
            <button class="btn" id="calNext" type="button">▶</button>
          </div>
          <span class="pill soft" id="mwBadge">이번 주가 자동 선택됨</span>
        </div>

        <div class="cal-grid">
          <div class="cal-dow">
            <div>월</div><div>화</div><div>수</div><div>목</div><div>금</div>
            <div class="sat">토</div><div class="sun">일</div>
          </div>
          <div id="calWeeks"></div>
        </div>

        <div style="margin-top:10px;font-size:12px;font-weight:900;opacity:.75;">
          · 월요일 시작 · “1일 포함 주 = 그 달 1주” · 주(가로줄) 클릭 → 미리보기
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn ghost" id="cancelCal" type="button">취소</button>
        <button class="btn" id="applyCal" type="button">적용</button>
      </div>
    </div>
  </div>

  <!-- ===== 공지 모달 ===== -->
  <div class="backdrop" id="noticeBackdrop" aria-modal="true" role="dialog">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><span class="pill">공지</span></div>
        <button class="btn" id="closeNotice" type="button">닫기</button>
      </div>
      <div class="modal-body" style="line-height:1.5;font-weight:900;">
        <div style="margin-bottom:10px;">✅ 현재 버전은 <b>Windows 11</b> 및 <b>Android(Chrome)</b> 환경에 최적화되어 있습니다.</div>
        <div style="opacity:.75;font-size:12px;">
          · 인쇄 시 색상 그대로 나오려면 “배경 그래픽(배경색/이미지)”를 켜줘!
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" id="okNotice" type="button">확인</button>
      </div>
    </div>
  </div>

  <!-- 가져오기용 -->
  <input id="importFile" type="file" accept="application/json" style="display:none;" />

  <script>
    const times = ["06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00","00:00","01:00"];
    const days = ["월","화","수","목","금","토","일"];

    const K = {
      data: "planner_data",
      title: "planner_custom_title",
      titleAuto: "planner_title_is_auto",
      dateOn: "planner_date_link_enabled",
      mw: "planner_monthweek",
      ori: "planner_print_orientation",
      theme: "planner_theme",
      backupOn: "planner_backup_enabled",
      backups: "planner_backups" // array of {ts:number, payload:string}
    };

    const THEMES = {
      pink:   { bg:"#fff4f8", border:"#f2c7d6", header:"#ffe0eb", timebg:"#ffedf4" },
      peach:  { bg:"#fff5ef", border:"#f0cbb5", header:"#ffe4d6", timebg:"#fff0e7" },
      lemon:  { bg:"#fffbe8", border:"#e9d9a7", header:"#fff1b8", timebg:"#fff7d6" },
      mint:   { bg:"#edfff9", border:"#b9e6d6", header:"#d7fff1", timebg:"#f2fffb" },
      lblue:  { bg:"#eef6ff", border:"#bcd3f5", header:"#d9e8ff", timebg:"#f4f9ff" },
      violet: { bg:"#f4f0ff", border:"#cbbdf2", header:"#e7ddff", timebg:"#f8f5ff" },
      ivory:  { bg:"#fffdf5", border:"#e6ddc8", header:"#f6f0df", timebg:"#fffaf0" }
    };

    // DOM
    const rowsEl = document.getElementById("rows");
    const plannerTable = document.getElementById("plannerTable");

    const themeSelect = document.getElementById("themeSelect");
    const dateLinkToggle = document.getElementById("dateLinkToggle");
    const dateSwitch = document.getElementById("dateSwitch");
    const pickWeekBtn = document.getElementById("pickWeekBtn");

    const backupToggle = document.getElementById("backupToggle");
    const backupSwitch = document.getElementById("backupSwitch");

    const orientationSelect = document.getElementById("orientationSelect");
    const printBtn = document.getElementById("printBtn");

    const exportBtn = document.getElementById("exportBtn");
    const importBtn = document.getElementById("importBtn");
    const importFile = document.getElementById("importFile");

    const resetSizeBtn = document.getElementById("resetSizeBtn");
    const resetAllBtn = document.getElementById("resetAllBtn");

    const titleBox = document.getElementById("titleBox");
    const plannerTitleText = document.getElementById("plannerTitleText");
    const plannerMetaText  = document.getElementById("plannerMetaText");

    // tooltip
    const tooltip = document.getElementById("tooltip");
    const tooltipMeta = document.getElementById("tooltipMeta");
    const tooltipBody = document.getElementById("tooltipBody");

    // joystick
    const joyFab = document.getElementById("joyFab");
    const joyPad = document.getElementById("joyPad");
    const joyClose = document.getElementById("joyClose");

    // cell modal
    const cellBackdrop = document.getElementById("cellBackdrop");
    const cellLabel = document.getElementById("cellLabel");
    const cellInput = document.getElementById("cellInput");
    const closeCell = document.getElementById("closeCell");
    const saveCellBtn = document.getElementById("saveCellBtn");
    const clearCellBtn = document.getElementById("clearCellBtn");

    // title modal
    const titleBackdrop = document.getElementById("titleBackdrop");
    const titleInput = document.getElementById("titleInput");
    const closeTitle = document.getElementById("closeTitle");
    const saveTitleBtn = document.getElementById("saveTitleBtn");
    const clearTitleBtn = document.getElementById("clearTitleBtn");

    // calendar modal
    const calBackdrop = document.getElementById("calBackdrop");
    const calLabel = document.getElementById("calLabel");
    const calPrev = document.getElementById("calPrev");
    const calNext = document.getElementById("calNext");
    const calToday = document.getElementById("calToday");
    const calThisWeek = document.getElementById("calThisWeek");
    const calWeeks = document.getElementById("calWeeks");
    const closeCal = document.getElementById("closeCal");
    const cancelCal = document.getElementById("cancelCal");
    const applyCal = document.getElementById("applyCal");
    const mwBadge = document.getElementById("mwBadge");

    // notice
    const noticeBackdrop = document.getElementById("noticeBackdrop");
    const noticeBtn = document.getElementById("noticeBtn");
    const closeNotice = document.getElementById("closeNotice");
    const okNotice = document.getElementById("okNotice");

    // calendar state
    let calYear = (new Date()).getFullYear();
    let calMonth = (new Date()).getMonth()+1;
    let selectedMonday = null;

    // preview state
    let previewMonday = null;
    let titleBackupBeforePreview = null;

    // cell edit state
    let editingCell = { r:null, c:null };

    // selected cell for nav
    let selectedRC = { r: 0, c: 0 };
    let lastPointerDownTS = 0;

    // long-press preview
    let longPressTimer = null;
    let longPressActive = false;

    // backup timer
    let backupIntervalId = null;

    const pad2 = n => String(n).padStart(2,"0");
    const cellId = (r,c) => `${r}-${c}`;

    function setSwitchVisual(wrapper, checked){
      wrapper.classList.toggle("on", checked);
    }

    function getData(){
      try { return JSON.parse(localStorage.getItem(K.data) || "{}"); }
      catch { return {}; }
    }
    function setData(obj){
      localStorage.setItem(K.data, JSON.stringify(obj));
    }

    function fmtKoreanDate(d){
      return `${d.getMonth()+1}월 ${d.getDate()}일`;
    }

    // Monday-based
    function getMondayFromDate(d){
      const date = new Date(d);
      const dow = (date.getDay()+6)%7; // Mon=0
      date.setDate(date.getDate()-dow);
      date.setHours(0,0,0,0);
      return date;
    }

    // "1일 포함 주 = 그달 1주"
    function getMonthWeek1Monday(year, month1to12){
      const first = new Date(year, month1to12-1, 1);
      return getMondayFromDate(first);
    }
    function getMonthWeekCount(year, month1to12){
      const week1Mon = getMonthWeek1Monday(year, month1to12);
      const last = new Date(year, month1to12, 0);
      const lastMon = getMondayFromDate(last);
      const diffDays = Math.round((lastMon-week1Mon)/(1000*60*60*24));
      return Math.floor(diffDays/7)+1;
    }
    function monthWeekNoFromMonday(year, month1to12, monday){
      const week1Mon = getMonthWeek1Monday(year, month1to12);
      const diffDays = Math.round((monday-week1Mon)/(1000*60*60*24));
      return Math.floor(diffDays/7)+1;
    }

    // ===== theme =====
    function applyTheme(key){
      const t = THEMES[key] || THEMES.lblue;
      document.documentElement.style.setProperty("--bg", t.bg);
      document.documentElement.style.setProperty("--border", t.border);
      document.documentElement.style.setProperty("--header", t.header);
      document.documentElement.style.setProperty("--timebg", t.timebg);
      localStorage.setItem(K.theme, key);
    }
    function initTheme(){
      const saved = localStorage.getItem(K.theme) || "lblue";
      themeSelect.value = saved;
      applyTheme(saved);
    }
    themeSelect.addEventListener("change", ()=> applyTheme(themeSelect.value));

    // ===== title =====
    function getTitle(){
      const t = (localStorage.getItem(K.title) || "").trim();
      return t ? t : "주간 플래너";
    }
    function setTitle(text, isAuto=false){
      const v = (text || "").trim();
      localStorage.setItem(K.title, v);
      localStorage.setItem(K.titleAuto, isAuto ? "1" : "0");
      applyTitleToUI();
    }
    function clearTitle(){
      localStorage.removeItem(K.title);
      localStorage.setItem(K.titleAuto, "0");
      applyTitleToUI();
    }
    function applyTitleToUI(){
      plannerTitleText.textContent = getTitle();
    }

    // title modal
    function openTitleModal(){
      titleInput.value = (localStorage.getItem(K.title) || "").trim();
      titleBackdrop.style.display="flex";
      setTimeout(()=>titleInput.focus(), 50);
    }
    function closeTitleModal(){ titleBackdrop.style.display="none"; }
    titleBox.addEventListener("click", openTitleModal);
    closeTitle.addEventListener("click", closeTitleModal);
    titleBackdrop.addEventListener("click", (e)=>{ if(e.target===titleBackdrop) closeTitleModal(); });

    saveTitleBtn.addEventListener("click", ()=>{
      setTitle(titleInput.value, false);
      closeTitleModal();
    });
    clearTitleBtn.addEventListener("click", ()=>{
      const ok = confirm("제목을 기본값(주간 플래너)로 돌릴까?");
      if(!ok) return;
      clearTitle();
      closeTitleModal();
    });

    // ===== header dates =====
    function clearHeaderDates(){
      document.querySelectorAll(".date[data-dow]").forEach(el=> el.textContent="");
      plannerMetaText.textContent = "";
      plannerTable.classList.add("no-date");
    }
    function applyWeekMonday(monday){
      plannerTable.classList.remove("no-date");
      const start = new Date(monday);
      const end = new Date(monday); end.setDate(monday.getDate()+6);

      document.querySelectorAll(".date[data-dow]").forEach(el=>{
        const i = Number(el.dataset.dow);
        const d = new Date(monday);
        d.setDate(monday.getDate()+i);
        el.textContent = `(${fmtKoreanDate(d)})`;
      });
      plannerMetaText.textContent = `기간: ${fmtKoreanDate(start)} ~ ${fmtKoreanDate(end)}`;
    }

    // ===== tooltip =====
    function hideTooltip(){
      tooltip.style.display = "none";
      longPressActive = false;
    }
    function showTooltipForCell(td, x, y){
      const full = td?.dataset?.full || "";
      if(!full || !full.trim()) return;

      tooltipMeta.textContent = `${times[Number(td.dataset.r)]} · ${days[Number(td.dataset.c)]}`;
      tooltipBody.textContent = full;

      tooltip.style.display = "block";

      const rect = tooltip.getBoundingClientRect();
      const pad = 10;
      let left = x + 12;
      let top  = y + 12;

      if(left + rect.width > window.innerWidth - pad) left = window.innerWidth - pad - rect.width;
      if(top + rect.height > window.innerHeight - pad) top = window.innerHeight - pad - rect.height;
      if(left < pad) left = pad;
      if(top < pad) top = pad;

      tooltip.style.left = left + "px";
      tooltip.style.top  = top + "px";
    }

    // ===== calendar =====
    function applyPreviewBadge(year, month1to12, monday){
      const start = new Date(monday);
      const end = new Date(monday); end.setDate(monday.getDate()+6);
      const wNo = monthWeekNoFromMonday(year, month1to12, monday);
      mwBadge.textContent = `미리보기: ${year}년 ${month1to12}월 ${wNo}주 · ${fmtKoreanDate(start)} ~ ${fmtKoreanDate(end)} ✅`;
    }

    function autoSelectThisWeek(){
      const now = new Date();
      const monday = getMondayFromDate(now);
      selectedMonday = monday;
      previewMonday = monday;
      calYear = now.getFullYear();
      calMonth = now.getMonth()+1;

      // 미리보기 즉시 반영
      applyWeekMonday(monday);
      applyPreviewBadge(calYear, calMonth, monday);
    }

    function openCal(){
      // 현재 상태 백업(적용 안 하고 닫으면 원복)
      titleBackupBeforePreview = {
        meta: plannerMetaText.textContent,
        dates: Array.from(document.querySelectorAll(".date[data-dow]")).map(el => el.textContent),
        noDate: plannerTable.classList.contains("no-date")
      };

      // ✅ 열자마자 "이번 주" 자동 선택 + 미리보기
      autoSelectThisWeek();

      calBackdrop.style.display="flex";
      renderCalendar(calYear, calMonth);
    }
    function closeCalModal(){
      calBackdrop.style.display="none";

      // 적용 안 하고 닫으면 미리보기 원복
      if (previewMonday && titleBackupBeforePreview){
        if (titleBackupBeforePreview.noDate){
          clearHeaderDates();
          plannerTable.classList.add("no-date");
        } else {
          plannerTable.classList.remove("no-date");
          const dates = titleBackupBeforePreview.dates || [];
          document.querySelectorAll(".date[data-dow]").forEach((el, idx)=>{
            el.textContent = dates[idx] || "";
          });
          plannerMetaText.textContent = titleBackupBeforePreview.meta || "";
        }
      }

      previewMonday = null;
      titleBackupBeforePreview = null;
    }

    function renderCalendar(year, month1to12){
      calLabel.textContent = `${year}년 ${month1to12}월`;
      const weekCount = getMonthWeekCount(year, month1to12);

      const startMon = getMonthWeek1Monday(year, month1to12);
      calWeeks.innerHTML = "";

      for(let w=1; w<=weekCount; w++){
        const monday = new Date(startMon);
        monday.setDate(startMon.getDate() + (w-1)*7);

        const weekEl = document.createElement("div");
        weekEl.className = "cal-week";
        weekEl.dataset.monday = monday.toISOString();

        for(let i=0;i<7;i++){
          const d = new Date(monday);
          d.setDate(monday.getDate()+i);
          const inMonth = (d.getMonth()+1) === month1to12;

          const cell = document.createElement("div");
          cell.className = "cal-cell" + (inMonth ? "" : " out") + (i===5 ? " sat" : "") + (i===6 ? " sun" : "");
          cell.innerHTML = `<div class="d">${d.getDate()}</div><div class="m">${d.getMonth()+1}월</div>`;
          weekEl.appendChild(cell);
        }

        const chosen = previewMonday ? previewMonday : (selectedMonday ? getMondayFromDate(selectedMonday) : null);
        if(chosen && chosen.getTime() === monday.getTime()){
          weekEl.classList.add("selected");
        }

        weekEl.addEventListener("click", ()=>{
          selectedMonday = new Date(weekEl.dataset.monday);
          previewMonday = getMondayFromDate(selectedMonday);

          applyWeekMonday(previewMonday);
          applyPreviewBadge(year, month1to12, previewMonday);

          renderCalendar(year, month1to12);
        });

        calWeeks.appendChild(weekEl);
      }
    }

    calPrev.addEventListener("click", ()=>{
      calMonth--;
      if(calMonth<1){ calMonth=12; calYear--; }
      renderCalendar(calYear, calMonth);
    });
    calNext.addEventListener("click", ()=>{
      calMonth++;
      if(calMonth>12){ calMonth=1; calYear++; }
      renderCalendar(calYear, calMonth);
    });
    calToday.addEventListener("click", ()=>{
      const now = new Date();
      calYear = now.getFullYear();
      calMonth = now.getMonth()+1;
      renderCalendar(calYear, calMonth);
    });
    calThisWeek.addEventListener("click", ()=>{
      autoSelectThisWeek();
      renderCalendar(calYear, calMonth);
    });

    applyCal.addEventListener("click", ()=>{
      if(!selectedMonday){
        alert("주를 선택해줘!");
        return;
      }

      const monday = previewMonday ? previewMonday : getMondayFromDate(selectedMonday);
      const w = monthWeekNoFromMonday(calYear, calMonth, monday);

      localStorage.setItem(K.mw, `${calYear}-${pad2(calMonth)}-W${w}`);
      applyWeekMonday(monday);

      const storedTitle = (localStorage.getItem(K.title) || "").trim();
      const titleAuto = localStorage.getItem(K.titleAuto) === "1";
      const userHasCustomTitle = storedTitle.length > 0 && !titleAuto;

      if(!userHasCustomTitle){
        const start = new Date(monday);
        const end = new Date(monday); end.setDate(monday.getDate()+6);
        const auto = `${calMonth}월 ${w}주 플래너(${fmtKoreanDate(start)} ~ ${fmtKoreanDate(end)})`;
        setTitle(auto, true);
      }

      previewMonday = null;
      titleBackupBeforePreview = null;
      closeCalModal();
    });

    closeCal.addEventListener("click", closeCalModal);
    cancelCal.addEventListener("click", closeCalModal);
    calBackdrop.addEventListener("click", (e)=>{ if(e.target===calBackdrop) closeCalModal(); });

    // ===== date link toggle =====
    function enableDateLink(enable, forcePick=false){
      dateLinkToggle.checked = enable;
      setSwitchVisual(dateSwitch, enable);
      localStorage.setItem(K.dateOn, enable ? "1":"0");

      pickWeekBtn.style.display = enable ? "inline-flex" : "none";

      if(!enable){
        clearHeaderDates();

        const wasAuto = localStorage.getItem(K.titleAuto) === "1";
        const storedTitle = (localStorage.getItem(K.title) || "").trim();
        if(wasAuto && storedTitle.length > 0) clearTitle();
        else applyTitleToUI();
        return;
      }

      if(forcePick){
        selectedMonday = null;
        previewMonday = null;
        openCal();
        return;
      }

      const saved = localStorage.getItem(K.mw);
      if(saved){
        const [sy, sm, sw] = saved.split("-");
        calYear = Number(sy);
        calMonth = Number(sm);
        const w = Number(sw.replace("W",""));
        const week1 = getMonthWeek1Monday(calYear, calMonth);
        const monday = new Date(week1);
        monday.setDate(week1.getDate() + (w-1)*7);
        selectedMonday = monday;
        applyWeekMonday(monday);
      }else{
        openCal();
      }
    }

    dateSwitch.addEventListener("click", ()=>{
      const next = !dateLinkToggle.checked;
      enableDateLink(next, next === true);
    });

    pickWeekBtn.addEventListener("click", ()=>{
      enableDateLink(true, true);
    });

    // ===== orientation =====
    function applyOrientation(value){
      document.documentElement.style.setProperty("--paper", value);
      document.documentElement.dataset.paper = value;
      localStorage.setItem(K.ori, value);
    }
    function initOrientation(){
      const saved = localStorage.getItem(K.ori) || "portrait";
      orientationSelect.value = saved;
      applyOrientation(saved);
    }
    orientationSelect.addEventListener("change", ()=> applyOrientation(orientationSelect.value));

    // ===== PRINT =====
    printBtn.addEventListener("click", ()=>{
      alert("색상 배경이 그대로 나오려면 인쇄 설정에서 '배경 그래픽(배경색/이미지)'를 켜줘!");
      window.print();
    });

    // ===== notice =====
    function openNotice(){ noticeBackdrop.style.display="flex"; }
    function closeNoticeModal(){ noticeBackdrop.style.display="none"; }
    noticeBtn.addEventListener("click", openNotice);
    closeNotice.addEventListener("click", closeNoticeModal);
    okNotice.addEventListener("click", closeNoticeModal);
    noticeBackdrop.addEventListener("click", (e)=>{ if(e.target===noticeBackdrop) closeNoticeModal(); });

    // ===== grid render + cell popup =====
    function renderGrid(){
      rowsEl.innerHTML = times.map((t, r)=>`
        <tr>
          <td class="time">${t}</td>
          ${Array.from({length:7}).map((_, c)=>
            `<td class="cell empty" data-r="${r}" data-c="${c}">
               <span class="expander" data-action="toggle"></span>
             </td>`
          ).join("")}
        </tr>
      `).join("");
    }

    function normalizeDisplay(full){
      const text = (full || "").replace(/\r/g,"");
      const firstLine = text.split("\n")[0] || "";
      const more = text.includes("\n") || firstLine.length > 18;
      // 표시 텍스트는 첫 줄만, 길면 ellipsis는 CSS가 처리
      return { firstLine: firstLine.trim(), hasMore: more };
    }

    function updateCellDisplay(td, fullValue){
      const full = (fullValue || "");
      td.dataset.full = full;

      if(!full.trim()){
        td.textContent = "";
        td.classList.add("empty");
        td.classList.remove("hasMore","expanded");
        td.innerHTML = `<span class="expander" data-action="toggle"></span>`;
        return;
      }

      const { firstLine, hasMore } = normalizeDisplay(full);

      td.classList.remove("empty");
      td.classList.toggle("hasMore", hasMore);

      // expanded면 full, 아니면 firstLine만
      const show = td.classList.contains("expanded") ? full : firstLine;

      // HTML 안전하게
      td.textContent = show;
      // expander 다시 붙이기
      const ex = document.createElement("span");
      ex.className = "expander";
      ex.dataset.action = "toggle";
      td.appendChild(ex);
    }

    function loadAllCells(){
      const data = getData();
      document.querySelectorAll("td.cell").forEach(td=>{
        const r = td.dataset.r, c = td.dataset.c;
        updateCellDisplay(td, data[cellId(r,c)] || "");
      });
    }

    function openCellModal(r, c){
      editingCell = { r, c };
      const data = getData();
      const val = data[cellId(r,c)] || "";
      cellInput.value = val;

      cellLabel.textContent = `${times[r]} · ${days[c]}`;
      cellBackdrop.style.display="flex";
      setTimeout(()=>cellInput.focus(), 50);
    }
    function closeCellModal(){
      cellBackdrop.style.display="none";
      editingCell = { r:null, c:null };
    }

    // select cell highlight
    function clearSelectedCell(){
      document.querySelectorAll("td.cell.selected").forEach(td=>td.classList.remove("selected"));
    }
    function selectCell(r, c, scrollInto=true){
      r = Math.max(0, Math.min(times.length-1, r));
      c = Math.max(0, Math.min(6, c));
      selectedRC = { r, c };

      clearSelectedCell();
      const td = document.querySelector(`td.cell[data-r="${r}"][data-c="${c}"]`);
      if(td){
        td.classList.add("selected");
        if(scrollInto){
          td.scrollIntoView({block:"nearest", inline:"nearest"});
        }
      }
    }

    function saveCellValue(r, c, value){
      const data = getData();
      const v = (value || "").replace(/\s+$/,"");
      const id = cellId(r,c);

      if(v.trim()==="") delete data[id];
      else data[id] = v;

      setData(data);

      const td = document.querySelector(`td.cell[data-r="${r}"][data-c="${c}"]`);
      if(td) updateCellDisplay(td, data[id] || "");
    }

    // click handlers on table
    rowsEl.addEventListener("click", (e)=>{
      const td = e.target.closest("td.cell");
      if(!td) return;

      // expander toggle
      const ex = e.target.closest(".expander");
      if(ex && td.classList.contains("hasMore")){
        td.classList.toggle("expanded");
        updateCellDisplay(td, td.dataset.full || "");
        return;
      }

      // normal click -> select + open input popup
      const r = Number(td.dataset.r), c = Number(td.dataset.c);
      selectCell(r, c, false);
      openCellModal(r, c);
    });

    // mouse hover preview (PC)
    rowsEl.addEventListener("mousemove", (e)=>{
      const td = e.target.closest("td.cell");
      if(!td) return;
      if(!td.dataset.full || !td.dataset.full.trim()) return;
      // only show tooltip when content is not fully visible (hasMore) OR expanded has long content
      if(td.classList.contains("hasMore") || (td.dataset.full && td.dataset.full.length > 30)){
        showTooltipForCell(td, e.clientX, e.clientY);
      }
    });
    rowsEl.addEventListener("mouseleave", ()=> hideTooltip());

    // mobile long-press preview (touch)
    function startLongPress(td, x, y){
      if(!td || !td.dataset.full || !td.dataset.full.trim()) return;
      longPressTimer = setTimeout(()=>{
        longPressActive = true;
        showTooltipForCell(td, x, y);
      }, 420);
    }
    function cancelLongPress(){
      if(longPressTimer){ clearTimeout(longPressTimer); longPressTimer = null; }
      if(longPressActive) hideTooltip();
    }

    rowsEl.addEventListener("touchstart", (e)=>{
      const td = e.target.closest("td.cell");
      if(!td) return;

      // expander touch -> don't long-press
      if(e.target.closest(".expander")) return;

      const t = e.touches[0];
      startLongPress(td, t.clientX, t.clientY);
    }, {passive:true});

    rowsEl.addEventListener("touchmove", ()=> cancelLongPress(), {passive:true});
    rowsEl.addEventListener("touchend", ()=> cancelLongPress(), {passive:true});
    rowsEl.addEventListener("touchcancel", ()=> cancelLongPress(), {passive:true});

    // cell modal events
    closeCell.addEventListener("click", closeCellModal);
    cellBackdrop.addEventListener("click", (e)=>{ if(e.target===cellBackdrop) closeCellModal(); });

    saveCellBtn.addEventListener("click", ()=>{
      const {r,c} = editingCell;
      if(r==null || c==null) return;
      saveCellValue(r, c, cellInput.value);
      closeCellModal();
    });

    // ✅ 비우기 = 즉시 저장 + 닫기
    clearCellBtn.addEventListener("click", ()=>{
      const {r,c} = editingCell;
      if(r==null || c==null) return;
      saveCellValue(r, c, "");
      closeCellModal();
    });

    // Ctrl+Enter save
    cellInput.addEventListener("keydown", (e)=>{
      if((e.ctrlKey || e.metaKey) && e.key === "Enter"){
        e.preventDefault();
        saveCellBtn.click();
      }
    });

    // ===== keyboard nav (Excel-like) =====
    document.addEventListener("keydown", (e)=>{
      // ignore when typing in inputs
      const tag = (document.activeElement?.tagName || "").toLowerCase();
      if(tag === "textarea" || tag === "input") return;

      if(e.key === "ArrowUp"){ e.preventDefault(); selectCell(selectedRC.r-1, selectedRC.c); }
      else if(e.key === "ArrowDown"){ e.preventDefault(); selectCell(selectedRC.r+1, selectedRC.c); }
      else if(e.key === "ArrowLeft"){ e.preventDefault(); selectCell(selectedRC.r, selectedRC.c-1); }
      else if(e.key === "ArrowRight"){ e.preventDefault(); selectCell(selectedRC.r, selectedRC.c+1); }
      else if(e.key === "Enter"){
        e.preventDefault();
        openCellModal(selectedRC.r, selectedRC.c);
      }
      else if(e.key === " "){
        // space toggles expand/collapse (if hasMore)
        const td = document.querySelector(`td.cell[data-r="${selectedRC.r}"][data-c="${selectedRC.c}"]`);
        if(td && td.classList.contains("hasMore")){
          e.preventDefault();
          td.classList.toggle("expanded");
          updateCellDisplay(td, td.dataset.full || "");
        }
      }
    });

    // ===== joystick =====
    joyFab.addEventListener("click", ()=>{
      joyPad.style.display = (joyPad.style.display === "block") ? "none" : "block";
    });
    joyClose.addEventListener("click", ()=> joyPad.style.display="none");

    joyPad.addEventListener("click", (e)=>{
      const btn = e.target.closest(".joy-btn");
      if(!btn) return;
      const dir = btn.dataset.dir;
      if(dir === "up") selectCell(selectedRC.r-1, selectedRC.c);
      if(dir === "down") selectCell(selectedRC.r+1, selectedRC.c);
      if(dir === "left") selectCell(selectedRC.r, selectedRC.c-1);
      if(dir === "right") selectCell(selectedRC.r, selectedRC.c+1);
      if(dir === "enter") openCellModal(selectedRC.r, selectedRC.c);
    });

    // ===== export/import =====
    exportBtn.addEventListener("click", ()=>{
      const ok = confirm("현재 내용을 JSON으로 내보낼까?");
      if(!ok) return;

      const payload = {
        app:"pasteltone-weekly-planner",
        version: 12,
        exportedAt: new Date().toISOString(),
        settings:{
          title: localStorage.getItem(K.title) || "",
          titleAuto: localStorage.getItem(K.titleAuto) || "0",
          dateOn: localStorage.getItem(K.dateOn) || "0",
          monthWeek: localStorage.getItem(K.mw) || "",
          orientation: localStorage.getItem(K.ori) || "portrait",
          theme: localStorage.getItem(K.theme) || "lblue",
          backupOn: localStorage.getItem(K.backupOn) || "0"
        },
        data: getData()
      };

      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const d = new Date();
      a.href = url;
      a.download = `weekly_planner_backup_${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener("click", ()=>{
      const ok = confirm("JSON 파일을 가져올까? (현재 내용이 덮어쓰기될 수 있어)");
      if(!ok) return;
      importFile.value="";
      importFile.click();
    });

    importFile.addEventListener("change", async ()=>{
      const file = importFile.files?.[0];
      if(!file) return;

      try{
        const text = await file.text();
        const json = JSON.parse(text);
        if(!json || typeof json !== "object" || !json.data){
          alert("형식이 올바르지 않은 JSON이야.");
          return;
        }

        const ok = confirm("정말 가져와서 현재 데이터를 덮어쓸까?");
        if(!ok) return;

        setData(json.data);

        if(json.settings){
          localStorage.setItem(K.title, json.settings.title || "");
          localStorage.setItem(K.titleAuto, json.settings.titleAuto || "0");
          localStorage.setItem(K.dateOn, json.settings.dateOn || "0");
          localStorage.setItem(K.mw, json.settings.monthWeek || "");
          localStorage.setItem(K.ori, json.settings.orientation || "portrait");
          localStorage.setItem(K.theme, json.settings.theme || "lblue");
          localStorage.setItem(K.backupOn, json.settings.backupOn || "0");
        }

        initTheme();
        initOrientation();
        applyTitleToUI();
        initBackupToggle();

        enableDateLink(localStorage.getItem(K.dateOn)==="1", false);

        loadAllCells();
        alert("가져오기 완료!");
      }catch{
        alert("가져오기 실패! 파일이 손상됐거나 JSON이 아니야.");
      }
    });

    // ===== reset =====
    resetSizeBtn.addEventListener("click", ()=>{
      alert("현재 버전은 크기 조절 기능은 다음 단계에서 더 정교하게 넣을 예정이야!");
    });

    resetAllBtn.addEventListener("click", ()=>{
      const ok = confirm("⚠️ 전체 초기화하면 입력한 내용/설정이 모두 삭제돼.\n정말 초기화할까?");
      if(!ok) return;

      Object.values(K).forEach(key => localStorage.removeItem(key));
      initTheme();
      initOrientation();
      initBackupToggle(true);
      applyTitleToUI();
      enableDateLink(false, false);
      loadAllCells();
      selectCell(0,0,false);
      alert("전체 초기화 완료!");
    });

    // ===== date link toggle =====
    // (already defined above) - wire button
    // pickWeekBtn is hidden when OFF
    pickWeekBtn.style.display = "none";

    // ===== backup (1분마다 저장, 5분 지난 건 자동 삭제, 켜고 끄기) =====
    function readBackups(){
      try{ return JSON.parse(localStorage.getItem(K.backups) || "[]"); }
      catch{ return []; }
    }
    function writeBackups(list){
      localStorage.setItem(K.backups, JSON.stringify(list));
    }
    function cleanupBackups(){
      const now = Date.now();
      const ttl = 5 * 60 * 1000; // 5분
      const list = readBackups().filter(b => b && typeof b.ts === "number" && (now - b.ts) <= ttl);
      writeBackups(list);
    }
    function makeSnapshot(){
      const payload = {
        ts: Date.now(),
        settings:{
          title: localStorage.getItem(K.title) || "",
          titleAuto: localStorage.getItem(K.titleAuto) || "0",
          dateOn: localStorage.getItem(K.dateOn) || "0",
          monthWeek: localStorage.getItem(K.mw) || "",
          orientation: localStorage.getItem(K.ori) || "portrait",
          theme: localStorage.getItem(K.theme) || "lblue"
        },
        data: getData()
      };
      return payload;
    }
    function doBackupTick(){
      cleanupBackups();
      const list = readBackups();
      list.push(makeSnapshot());
      writeBackups(list);
      cleanupBackups();
    }
    function startBackup(){
      stopBackup();
      doBackupTick(); // 켜자마자 1회
      backupIntervalId = setInterval(doBackupTick, 60 * 1000);
    }
    function stopBackup(){
      if(backupIntervalId){
        clearInterval(backupIntervalId);
        backupIntervalId = null;
      }
    }
    function setBackupEnabled(on){
      backupToggle.checked = on;
      setSwitchVisual(backupSwitch, on);
      localStorage.setItem(K.backupOn, on ? "1":"0");
      if(on) startBackup(); else stopBackup();
      if(!on) cleanupBackups();
    }
    function initBackupToggle(forceOff=false){
      const saved = forceOff ? "0" : (localStorage.getItem(K.backupOn) || "0");
      setBackupEnabled(saved === "1");
    }

    backupSwitch.addEventListener("click", ()=>{
      const next = !backupToggle.checked;
      setBackupEnabled(next);
    });

    // ===== init =====
    function initOrientation(){
      const saved = localStorage.getItem(K.ori) || "portrait";
      orientationSelect.value = saved;
      applyOrientation(saved);
    }

    function initDateSwitch(){
      const enabled = localStorage.getItem(K.dateOn) === "1";
      enableDateLink(enabled, false);
      setSwitchVisual(dateSwitch, dateLinkToggle.checked);
    }

    function init(){
      renderGrid();
      loadAllCells();

      initTheme();
      initOrientation();
      initBackupToggle();
      applyTitleToUI();

      initDateSwitch();

      // 기본 셀 선택(엑셀 느낌)
      selectCell(0,0,false);

      // expander가 먹히도록 첫 로드에서 hasMore 계산 반영됨
    }

    // ===== date switch init function needs to exist before call =====
    // (enableDateLink already declared earlier)
    // also keep switch visual synced
    setSwitchVisual(dateSwitch, dateLinkToggle.checked);
    setSwitchVisual(backupSwitch, backupToggle.checked);

    init();

    // hide tooltip on scroll
    document.addEventListener("scroll", ()=> hideTooltip(), {passive:true});
    window.addEventListener("resize", ()=> hideTooltip());

    // prevent tooltip stuck
    document.addEventListener("pointerdown", ()=>{
      const now = Date.now();
      if(now - lastPointerDownTS < 120) hideTooltip();
      lastPointerDownTS = now;
    });

  </script>
</body>
</html>
